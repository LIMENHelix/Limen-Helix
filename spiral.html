<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>LIMEN HELIX</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{background:#000;color:#e8e3d9;font-family:monospace;overflow:hidden;height:100%;width:100%;-webkit-user-select:none;user-select:none}
canvas{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0}
.hud-top{position:fixed;top:12px;left:0;right:0;z-index:100;display:flex;justify-content:center;gap:3px;padding:0 8px}
.hud-top button{width:28px;height:28px;font-size:0.5rem;letter-spacing:1px;font-family:monospace;border:1px solid rgba(201,169,78,0.08);background:transparent;color:rgba(201,169,78,0.25);border-radius:50%;cursor:pointer;transition:all 0.5s;display:flex;align-items:center;justify-content:center}
.hud-top button.act{border-color:rgba(201,169,78,0.5);color:rgba(201,169,78,0.9);box-shadow:0 0 15px rgba(201,169,78,0.15)}
.hud-top button.locked{opacity:0.1;cursor:not-allowed}
.phase-label{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:50;text-align:center;pointer-events:none;transition:opacity 0.8s}
.phase-num{font-size:clamp(4rem,12vw,8rem);font-weight:100;letter-spacing:clamp(8px,3vw,25px);opacity:0.1;font-family:Georgia,serif;transition:color 0.8s}
.phase-name{font-size:clamp(0.6rem,1.8vw,0.8rem);letter-spacing:clamp(6px,2vw,15px);text-transform:uppercase;opacity:0.5;margin-top:-8px;transition:color 0.8s}
.hud-bl{position:fixed;bottom:12px;left:14px;z-index:100;font-size:0.45rem;letter-spacing:2px;text-transform:uppercase}
.hud-br{position:fixed;bottom:12px;right:14px;z-index:100;font-size:0.45rem;letter-spacing:2px;text-transform:uppercase;text-align:right}
.hud-tl{position:fixed;top:50px;left:14px;z-index:100;font-size:0.4rem;letter-spacing:2px;text-transform:uppercase;opacity:0.6}
.hud-tr{position:fixed;top:50px;right:14px;z-index:100;font-size:0.4rem;letter-spacing:2px;text-transform:uppercase;text-align:right;opacity:0.6}
.scanline{position:fixed;top:0;left:0;right:0;bottom:0;z-index:5;pointer-events:none;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.02) 2px,rgba(0,0,0,0.02) 4px)}
.flash{position:fixed;inset:0;z-index:90;pointer-events:none;opacity:0;transition:opacity 0.15s}
.flash.on{opacity:1}
.lock{position:fixed;inset:0;z-index:200;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,0.95);text-align:center}
.lock-btn{display:inline-block;padding:10px 25px;border:1px solid rgba(201,169,78,0.3);color:#C9A94E;text-decoration:none;font-size:0.55rem;letter-spacing:3px;text-transform:uppercase;font-family:monospace;border-radius:2px}
.phase-enter{font-size:clamp(0.7rem,2.5vw,1rem);letter-spacing:8px;color:rgba(201,169,78,0);cursor:pointer;pointer-events:none;margin-top:12px;transition:color 2s,opacity 0.5s;text-transform:uppercase;animation:enterPulse 3s ease-in-out infinite}
.phase-enter.vis{color:rgba(201,169,78,0.65);pointer-events:auto}
@keyframes enterPulse{0%,100%{opacity:0.6}50%{opacity:1}}
#immersive-overlay{position:fixed;inset:0;z-index:300;pointer-events:none;opacity:0;transition:opacity 1s}
#immersive-narration{position:fixed;bottom:8%;left:50%;transform:translateX(-50%);z-index:310;font-family:monospace;font-size:clamp(0.75rem,3vw,1.1rem);letter-spacing:3px;color:rgba(201,169,78,0);text-align:center;transition:color 1.5s;text-transform:uppercase;pointer-events:none;line-height:2.2;max-width:80vw}
#immersive-source{position:fixed;top:8%;left:50%;transform:translateX(-50%);z-index:310;font-family:monospace;font-size:clamp(0.5rem,1.5vw,0.7rem);letter-spacing:3px;color:rgba(201,169,78,0);text-align:center;transition:color 1.5s;text-transform:uppercase;pointer-events:none}
#immersive-exit{position:fixed;top:14px;right:14px;z-index:320;font-family:monospace;font-size:0.5rem;letter-spacing:3px;color:rgba(201,169,78,0);cursor:pointer;transition:color 0.5s;text-transform:uppercase;padding:8px}
#immersive-exit.vis{color:rgba(201,169,78,0.3);pointer-events:auto}
#immersive-exit.vis:hover{color:rgba(201,169,78,0.7)}
</style>
</head>
<body>
<canvas id="c"></canvas>
<div class="scanline"></div>
<div class="flash" id="flash"></div>
<div class="hud-top" id="nav"></div>
<div class="phase-label" id="plabel"><div class="phase-num" id="pnum">0</div><div class="phase-name" id="pname">SOURCE</div><div class="phase-enter" id="penter" onclick="enterPhaseExperience()">⊘ ENTER</div></div>
<div class="hud-tl" id="htl"></div>
<div class="hud-tr" id="htr"></div>
<div class="hud-bl" id="hbl"></div>
<div class="hud-br" id="hbr"></div>
<div id="lock-container"></div>
<div id="immersive-overlay"></div>
<div id="immersive-narration"></div>
<div id="immersive-source"></div>
<div id="immersive-exit" onclick="exitPhaseExperience()">✕ EXIT</div>
<script>
// ═══ PHASE DATA ═══
var PH=[
{id:0,name:"SOURCE",dmn:"DMN:ACTIVE",neural:"VAGAL.ONSET",aR:160,aG:170,aB:180,nodeActivity:1.0,connectivity:1.0,chaos:0,dissolution:0,fireRate:0.5,waveAmp:1,branchDepth:4,txt:["I AM","I ALWAYS","I NEVER","I SHOULD","I PREDICT","I KNOW","I FEAR","I REMEMBER"]},
{id:1,name:"LIGHT",dmn:"SALIENCE:FIRING",neural:"AMYGDALA.ALERT",aR:255,aG:230,aB:180,nodeActivity:1.2,connectivity:0.9,chaos:0.2,dissolution:0,fireRate:1.5,waveAmp:1.4,branchDepth:4,txt:["WAIT","WHAT IS","THE WALL","WHO BUILT","WALLS"]},
{id:2,name:"RHYTHM",dmn:"DYAD:ENTRAINED",neural:"OXYTOCIN.SYNC",aR:170,aG:140,aB:230,nodeActivity:1.0,connectivity:1.2,chaos:0.1,dissolution:0,fireRate:0.7,waveAmp:0.8,branchDepth:5,txt:["YOU ARE","WE ARE","SYNC","TOGETHER"]},
{id:3,name:"DARKNESS",dmn:"SHADOW:ACCESSED",neural:"AMYGDALA.FLOOD",aR:180,aG:30,aB:30,nodeActivity:1.5,connectivity:0.7,chaos:0.5,dissolution:0.1,fireRate:3.0,waveAmp:2.0,branchDepth:3,txt:["BURIED","AFRAID","REFUSED"]},
{id:4,name:"PEACE",dmn:"VAGAL:LOCKED",neural:"GABA.INCREASE",aR:200,aG:190,aB:150,nodeActivity:0.6,connectivity:0.9,chaos:0,dissolution:0.05,fireRate:0.2,waveAmp:0.4,branchDepth:5,txt:["STILL","SAFE","REST"]},
{id:5,name:"ENDURANCE",dmn:"HORMETIC:LOADING",neural:"BDNF.EXPRESS",aR:250,aG:120,aB:30,nodeActivity:1.8,connectivity:0.8,chaos:0.6,dissolution:0.05,fireRate:4.0,waveAmp:2.5,branchDepth:3,txt:["HOLD","BEND","STRONGER"]},
{id:6,name:"ORDER",dmn:"EXEC:INTEGRATED",neural:"DLPFC.GOVERN",aR:80,aG:140,aB:220,nodeActivity:1.0,connectivity:1.4,chaos:0,dissolution:0.1,fireRate:0.8,waveAmp:0.6,branchDepth:6,txt:["STRUCTURE","BUILD","ORDER"]},
{id:7,name:"SEPARATION",dmn:"EGO:OFFLINE",neural:"MPFC.DOWN",aR:150,aG:150,aB:150,nodeActivity:0.3,connectivity:0.2,chaos:0.3,dissolution:0.7,fireRate:0.1,waveAmp:0.2,branchDepth:2,txt:["WHO","..."]},
{id:8,name:"CONSCIENCE",dmn:"EMPATHY:REWRITE",neural:"VMPFC.RECAL",aR:220,aG:70,aB:70,nodeActivity:1.2,connectivity:1.0,chaos:0.2,dissolution:0.3,fireRate:1.2,waveAmp:1.0,branchDepth:4,txt:["THEY FEEL","WE SHARE"]},
{id:9,name:"THRESHOLD",dmn:"DMN:DISSOLVED",neural:"CLAUSTRUM.FIRE",aR:201,aG:169,aB:78,nodeActivity:0.05,connectivity:0.02,chaos:0.8,dissolution:0.97,fireRate:0.02,waveAmp:0.05,branchDepth:0,txt:[]},
{id:10,name:"RESURRECTION",dmn:"DMN:RECONSTITUTED",neural:"TOPOLOGY.NOVEL",aR:255,aG:220,aB:100,nodeActivity:1.1,connectivity:1.3,chaos:0.05,dissolution:0,fireRate:0.9,waveAmp:1.2,branchDepth:5,txt:["I AM","WE ARE","I BUILD","SOURCE"]}
];

// ═══ DMN NODES — real neuroanatomy ═══
// Positions are relative (0-1) and will be scaled to screen
// These are the actual core regions of the Default Mode Network
var DMN_NODES=[
{name:"mPFC",label:"MEDIAL\nPREFRONTAL",x:0.5,y:0.22,r:1.0,role:"self-referential"},  // medial prefrontal cortex
{name:"PCC",label:"POSTERIOR\nCINGULATE",x:0.5,y:0.55,r:0.9,role:"autobiographical"},     // posterior cingulate cortex
{name:"LTC_L",label:"L.TEMPORAL",x:0.22,y:0.42,r:0.7,role:"semantic"},                      // left lateral temporal
{name:"LTC_R",label:"R.TEMPORAL",x:0.78,y:0.42,r:0.7,role:"semantic"},                      // right lateral temporal
{name:"HF_L",label:"L.HIPPO",x:0.28,y:0.65,r:0.6,role:"memory"},                           // left hippocampal formation
{name:"HF_R",label:"R.HIPPO",x:0.72,y:0.65,r:0.6,role:"memory"},                           // right hippocampal formation
{name:"IPL_L",label:"L.PARIETAL",x:0.18,y:0.35,r:0.5,role:"attention"},                     // left inferior parietal lobule
{name:"IPL_R",label:"R.PARIETAL",x:0.82,y:0.35,r:0.5,role:"attention"},                     // right inferior parietal lobule
{name:"ACC",label:"ANTERIOR\nCINGULATE",x:0.5,y:0.32,r:0.6,role:"conflict"},                // anterior cingulate
{name:"TPJ_L",label:"L.TPJ",x:0.25,y:0.5,r:0.5,role:"theory-of-mind"},                     // left temporoparietal junction
{name:"TPJ_R",label:"R.TPJ",x:0.75,y:0.5,r:0.5,role:"theory-of-mind"},                     // right temporoparietal junction
{name:"vmPFC",label:"VENTROMEDIAL\nPFC",x:0.5,y:0.28,r:0.55,role:"valuation"}              // ventromedial PFC
];

// Connections — actual white matter tracts between DMN regions
var DMN_CONNECTIONS=[
[0,1],[0,2],[0,3],[0,8],[0,11],  // mPFC hub connections
[1,4],[1,5],[1,9],[1,10],         // PCC hub connections
[2,6],[2,9],[3,7],[3,10],         // temporal-parietal
[4,9],[5,10],                     // hippocampal-TPJ
[0,1],                            // mPFC-PCC (strongest DMN connection)
[8,11],[8,1],                     // ACC connections
[6,9],[7,10],                     // parietal-TPJ
[2,4],[3,5]                       // temporal-hippocampal
];

// Action potentials in transit
var actionPotentials=[];
var AP_MAX=60;

// ═══ USER INTERACTION STATE ═══
var mouseX=-1,mouseY=-1,touchActive=false,hoveredNode=-1,tappedNode=-1,tapFade=0;

// Node descriptions — what each region does, who it affects
var NODE_INFO={
"mPFC":{fn:"SELF-NARRATIVE ENGINE",desc:"Generates your story about who you are",
  pop:"DEPRESSION: hyperactive rumination loops\nCONSPIRACY: overactive pattern-narration\nMEDITATORS: learned to quiet this region",
  phase7:"THIS REGION GOES OFFLINE FIRST"},
"PCC":{fn:"AUTOBIOGRAPHICAL MEMORY HUB",desc:"Anchors you to your past identity",
  pop:"PTSD: locked in trauma replay\nPSYCHEDELICS: first region suppressed\nASD: reduced connectivity to mPFC"},
"LTC_L":{fn:"LEFT SEMANTIC PROCESSING",desc:"Meaning-making from language",
  pop:"SCHIZOTYPY: aberrant meaning assignment\nCONSPIRACY: hyperactive pattern detection\nFLOW STATE: temporarily suppressed"},
"LTC_R":{fn:"RIGHT SEMANTIC PROCESSING",desc:"Pattern recognition across contexts",
  pop:"ADHD: fails to suppress during tasks\nCREATIVITY: enhanced cross-domain linking\nASD: often compensatory hyperactive"},
"HF_L":{fn:"LEFT HIPPOCAMPAL FORMATION",desc:"Memory encoding and consolidation",
  pop:"PTSD: intrusive memory fragments\nDEPRESSION: negativity-biased recall\nMEDITATION: enhanced by practice"},
"HF_R":{fn:"RIGHT HIPPOCAMPAL FORMATION",desc:"Spatial and emotional memory",
  pop:"TRAUMA: stores somatic memory\nPSYCHEDELICS: memory reconsolidation\nFASTING: altered metabolic input"},
"IPL_L":{fn:"LEFT INFERIOR PARIETAL",desc:"Self-other distinction boundary",
  pop:"ASD: rigid self-other boundary\nPRAYER: boundary dissolves (Newberg 2003)\nEGO DISSOLUTION: deactivates"},
"IPL_R":{fn:"RIGHT INFERIOR PARIETAL",desc:"Attention and spatial awareness",
  pop:"ADHD: underconnected\nFLOAT TANKS: sensory depriv target\nDRUMMING: entrained by rhythm"},
"ACC":{fn:"ANTERIOR CINGULATE CORTEX",desc:"Conflict monitor — error detection",
  pop:"DEPRESSION: hyperactive error signal\nOCD: stuck conflict loop\nPHASE 6 ORDER: strengthened here"},
"TPJ_L":{fn:"LEFT TEMPOROPARIETAL JUNCTION",desc:"Theory of mind — reading others",
  pop:"ASD: underconnected (social cognition)\nEMPATHY: core region\nPHASE 8: restructured here"},
"TPJ_R":{fn:"RIGHT TEMPOROPARIETAL JUNCTION",desc:"Self-awareness and agency",
  pop:"DISSOCIATION: disconnected\nOUT-OF-BODY: deactivates\nPHASE 7: goes offline"},
"vmPFC":{fn:"VENTROMEDIAL PFC",desc:"Value judgments and moral reasoning",
  pop:"PSYCHOPATHY: reduced activity\nMORAL INJURY: overloaded\nPHASE 8 CONSCIENCE: recalibrated"}
};

// ═══ TIER GATING ═══
var TIERS=[{tier:0,min:5,label:'Initiate',phases:[0],color:'#888'},{tier:1,min:20,label:'Seeker',phases:[0,1],color:'#9a8a5a'},{tier:2,min:50,label:'Acolyte',phases:[0,1,2],color:'#a89050'},{tier:3,min:100,label:'Disciple',phases:[0,1,2,3],color:'#b89840'},{tier:4,min:200,label:'Adept',phases:[0,1,2,3,4],color:'#c8a030'},{tier:5,min:500,label:'Oracle',phases:[0,1,2,3,4,5],color:'#d0a828'},{tier:6,min:1000,label:'Architect',phases:[0,1,2,3,4,5,6],color:'#d8b020'},{tier:7,min:2500,label:'Hierophant',phases:[0,1,2,3,4,5,6,7],color:'#e0b818'},{tier:8,min:5000,label:'Threshold Keeper',phases:[0,1,2,3,4,5,6,7,8],color:'#e8c010'},{tier:9,min:10000,label:'Phase Walker',phases:[0,1,2,3,4,5,6,7,8,9],color:'#f0c808'},{tier:10,min:25000,label:'Source Aligned',phases:[0,1,2,3,4,5,6,7,8,9,10],color:'#f8d000'},{tier:11,min:50000,label:'Resurrected',phases:[0,1,2,3,4,5,6,7,8,9,10],color:'#ffd700'}];
var params=new URLSearchParams(window.location.search);var isAdmin=params.get('limen')==='spiral99';
var skipTunnel=params.get('skip')==='1';
var access;try{access=JSON.parse(localStorage.getItem('limenAccess'))||{totalPaid:0,tier:-1}}catch(e){access={totalPaid:0,tier:-1}}
var userTier=isAdmin?11:access.tier;var currentTierData=TIERS[Math.max(0,Math.min(userTier,11))]||TIERS[0];
function isUnlocked(id){return isAdmin||currentTierData.phases.indexOf(id)!==-1}
// First-time access — play the tunnel
var tunnelSeen=false;try{tunnelSeen=localStorage.getItem('limenTunnelSeen')==='1'}catch(e){}
if(!tunnelSeen&&!skipTunnel&&(userTier>=0||isAdmin)){
  window.location.href='tunnel.html'+window.location.search;
}
if(userTier<0&&!isAdmin){document.body.innerHTML='<div style="min-height:100vh;display:flex;align-items:center;justify-content:center;flex-direction:column;text-align:center;padding:2rem;background:#000;font-family:monospace"><div style="font-size:0.5rem;color:rgba(201,169,78,0.3);letter-spacing:6px;margin-bottom:2rem">LIMEN HELIX</div><div style="font-size:2rem;opacity:0.15;margin-bottom:1rem">\u2298</div><p style="color:#888;font-size:0.75rem;letter-spacing:2px;margin-bottom:2rem">ACCESS REQUIRED</p><a href="https://chapel-pos-v2.vercel.app" style="display:inline-block;padding:10px 25px;border:1px solid rgba(201,169,78,0.3);color:#C9A94E;text-decoration:none;font-size:0.55rem;letter-spacing:3px;font-family:monospace;border-radius:2px">\u2726 OFFER</a></div>'}

var phase=0,t=0,canvas=document.getElementById('c'),ctx=canvas.getContext('2d'),W,H;
var immersiveMode=false,immersiveT=0,immersiveZoom=0,immersiveFocusNode=0;
// Show ENTER button after 2 seconds on each phase
var enterTimer=null;
function showEnterBtn(){var el=document.getElementById('penter');if(el&&isUnlocked(phase))el.classList.add('vis')}
function hideEnterBtn(){var el=document.getElementById('penter');if(el)el.classList.remove('vis');clearTimeout(enterTimer)}
setTimeout(showEnterBtn,2500);
function resize(){W=window.innerWidth;H=window.innerHeight;canvas.width=W*2;canvas.height=H*2;ctx.setTransform(2,0,0,2,0,0)}
window.addEventListener('resize',resize);resize();

function buildNav(){var nav=document.getElementById('nav');nav.innerHTML='';for(var i=0;i<PH.length;i++){var b=document.createElement('button');b.textContent=i;b.className=i===phase?'act':(!isUnlocked(i)?'locked':'');b.onclick=(function(idx){return function(){if(isUnlocked(idx))setPhase(idx)}})(i);nav.appendChild(b)}}
function setPhase(n){if(n===phase)return;hideEnterBtn();var fl=document.getElementById('flash');fl.style.background='rgba('+PH[n].aR+','+PH[n].aG+','+PH[n].aB+',0.08)';fl.className='flash on';document.getElementById('plabel').style.opacity='0';actionPotentials=[];setTimeout(function(){phase=n;updateHUD();buildNav();checkLock();fl.className='flash';setTimeout(function(){document.getElementById('plabel').style.opacity='1';enterTimer=setTimeout(showEnterBtn,2500)},150)},250)}
function checkLock(){var lc=document.getElementById('lock-container');if(!isUnlocked(phase)){var needed=TIERS.find(function(ti){return ti.phases.indexOf(phase)!==-1});var amt=needed?needed.min:50000;lc.innerHTML='<div class="lock"><p style="font-size:0.5rem;color:rgba(201,169,78,0.3);letter-spacing:4px;margin-bottom:1rem">PHASE '+phase+' \xb7 '+PH[phase].name+'</p><p style="font-size:0.4rem;color:#444;letter-spacing:2px;margin-bottom:1.5rem">REQUIRES '+needed.label.toUpperCase()+' \xb7 $'+amt.toLocaleString()+'</p><a href="https://chapel-pos-v2.vercel.app" class="lock-btn">\u2726 UNLOCK</a></div>'}else{lc.innerHTML=''}}
function updateHUD(){var p=PH[phase];var ac='rgb('+p.aR+','+p.aG+','+p.aB+')';document.getElementById('pnum').textContent=p.id;document.getElementById('pnum').style.color=ac;document.getElementById('pname').textContent=p.name;document.getElementById('pname').style.color='rgba('+p.aR+','+p.aG+','+p.aB+',0.5)';document.getElementById('htl').innerHTML='<span style="color:'+ac+'">'+p.dmn+'</span>';document.getElementById('htr').innerHTML='<span style="color:'+ac+'">'+p.neural+'</span>';document.getElementById('hbl').innerHTML='<span style="color:'+ac+'">NODES:'+Math.round(DMN_NODES.length*(1-p.dissolution))+' CONN:'+Math.round(p.connectivity*100)+'% FIRE:'+p.fireRate.toFixed(1)+'Hz</span>';document.getElementById('hbr').innerHTML='<span style="color:'+ac+'">CHAOS:'+Math.round(p.chaos*100)+'% WAVE:'+p.waveAmp.toFixed(1)+' DIS:'+Math.round(p.dissolution*100)+'%</span>'}

// ═══ DENDRITIC BRANCH GENERATOR ═══
function drawDendrite(x,y,angle,length,depth,alpha,p){
if(depth<=0||length<3||alpha<0.005)return;
var endX=x+Math.cos(angle)*length;
var endY=y+Math.sin(angle)*length;
ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(endX,endY);
ctx.strokeStyle='rgba('+p.aR+','+p.aG+','+p.aB+','+alpha+')';
ctx.lineWidth=Math.max(0.3,depth*0.4);ctx.stroke();
// Branch — real dendrites branch at ~30-45 degree angles
var branchAngle=0.4+Math.random()*0.3;
var shrink=0.6+Math.random()*0.15;
drawDendrite(endX,endY,angle-branchAngle,length*shrink,depth-1,alpha*0.7,p);
drawDendrite(endX,endY,angle+branchAngle,length*shrink,depth-1,alpha*0.7,p);
// Occasional third branch (real neurons do this)
if(Math.random()<0.3&&depth>2){
drawDendrite(endX,endY,angle+(Math.random()-0.5)*0.8,length*shrink*0.8,depth-1,alpha*0.5,p);
}}

// ═══ FIRE ACTION POTENTIAL ═══
function fireAP(connIdx,p){
if(actionPotentials.length>=AP_MAX)return;
var conn=DMN_CONNECTIONS[connIdx%DMN_CONNECTIONS.length];
actionPotentials.push({from:conn[0],to:conn[1],progress:0,speed:0.008+Math.random()*0.012,color:p});}

// ═══ MAIN DRAW ═══
function draw(){
var p=PH[phase];var cx=W/2,cy=H/2,maxD=Math.max(W,H);
var aRGB=p.aR+','+p.aG+','+p.aB;
ctx.clearRect(0,0,W,H);

// ── IMMERSIVE MODE — first-person neural experience ──
if(immersiveMode){
  drawImmersive(ctx,p,W,H,t);
  t+=16;requestAnimationFrame(draw);return;
}

// === DEEP SPACE BACKGROUND ===
var bg=ctx.createRadialGradient(cx,cy,0,cx,cy,maxD*0.7);
bg.addColorStop(0,'rgba('+Math.floor(p.aR*0.06)+','+Math.floor(p.aG*0.06)+','+Math.floor(p.aB*0.06)+',1)');
bg.addColorStop(0.5,'rgba('+Math.floor(p.aR*0.02)+','+Math.floor(p.aG*0.02)+','+Math.floor(p.aB*0.02)+',1)');
bg.addColorStop(1,'rgba(0,0,0,1)');
ctx.fillStyle=bg;ctx.fillRect(0,0,W,H);

// === OSCILLATORY WAVE FIELD (EEG-like) ===
// Alpha/theta/gamma waves rippling through the network
var waveCount=3;
for(var wv=0;wv<waveCount;wv++){
var freq=[0.003,0.008,0.02][wv]; // theta, alpha, gamma
var amp=p.waveAmp*[30,18,8][wv];
var wAlpha=[0.04,0.03,0.025][wv]*p.nodeActivity;
if(wAlpha<0.003)continue;
ctx.beginPath();
for(var wx=0;wx<W;wx+=2){
var wy=cy+Math.sin(wx*freq+t*0.002*(wv+1))*amp+Math.sin(wx*freq*2.3+t*0.003)*amp*0.3;
wy+=Math.sin(t*0.001+wv)*20; // drift
if(wx===0)ctx.moveTo(wx,wy);else ctx.lineTo(wx,wy);
}
ctx.strokeStyle='rgba('+aRGB+','+wAlpha+')';ctx.lineWidth=0.8;ctx.stroke();
}

// === WHITE MATTER FIBER TRACTS (connections between nodes) ===
for(var ci=0;ci<DMN_CONNECTIONS.length;ci++){
var conn=DMN_CONNECTIONS[ci];
var n1=DMN_NODES[conn[0]],n2=DMN_NODES[conn[1]];
var x1=n1.x*W,y1=n1.y*H,x2=n2.x*W,y2=n2.y*H;

// Connection strength varies with phase connectivity
var cAlpha=0.08*p.connectivity*(1-p.dissolution*0.9);
// Add pulsing — connections breathe
cAlpha*=0.7+0.3*Math.sin(t*0.002+ci*0.7);

if(cAlpha<0.005)continue;

// Curved fiber tract (real axon bundles curve, they don't go straight)
var midX=(x1+x2)/2+Math.sin(ci*2.3)*30;
var midY=(y1+y2)/2+Math.cos(ci*1.7)*20;
ctx.beginPath();ctx.moveTo(x1,y1);ctx.quadraticCurveTo(midX,midY,x2,y2);
ctx.strokeStyle='rgba('+aRGB+','+cAlpha+')';ctx.lineWidth=1+p.connectivity*0.8;ctx.stroke();

// Myelin sheath shimmer — dashed overlay
if(p.connectivity>0.5){
ctx.setLineDash([4,8]);
ctx.beginPath();ctx.moveTo(x1,y1);ctx.quadraticCurveTo(midX,midY,x2,y2);
ctx.strokeStyle='rgba(255,255,255,'+(cAlpha*0.3)+')';ctx.lineWidth=0.3;ctx.stroke();
ctx.setLineDash([]);
}}

// === NEURAL NODES (brain regions) ===
// Seed random for consistent dendrites per frame
var savedRandom=Math.random;
for(var ni=0;ni<DMN_NODES.length;ni++){
var node=DMN_NODES[ni];
var nx=node.x*W,ny=node.y*H;
var nodeR=maxD*0.018*node.r;

// Node dissolution
var nodeDis=p.dissolution;
// In Phase 7, mPFC (index 0) goes offline first
if(phase===7&&ni===0)nodeDis=Math.min(1,nodeDis+0.3);
// In Phase 7, PCC (index 1) goes offline
if(phase===7&&ni===1)nodeDis=Math.min(1,nodeDis+0.2);

var nodeAlpha=(1-nodeDis)*p.nodeActivity;
if(nodeAlpha<0.01)continue;

// Jitter from chaos
var jx=nx+Math.sin(t*0.005*p.chaos+ni*3.7)*maxD*0.01*p.chaos;
var jy=ny+Math.cos(t*0.004*p.chaos+ni*2.3)*maxD*0.01*p.chaos;

// === SOMA (cell body) GLOW ===
var somaGlow=ctx.createRadialGradient(jx,jy,0,jx,jy,nodeR*3);
somaGlow.addColorStop(0,'rgba('+aRGB+','+(0.15*nodeAlpha)+')');
somaGlow.addColorStop(0.4,'rgba('+aRGB+','+(0.05*nodeAlpha)+')');
somaGlow.addColorStop(1,'rgba(0,0,0,0)');
ctx.fillStyle=somaGlow;ctx.beginPath();ctx.arc(jx,jy,nodeR*3,0,Math.PI*2);ctx.fill();

// === SOMA CORE ===
// Firing pulse — the node brightens when it fires
var firePhase=(t*p.fireRate*0.01+ni*1.3)%(Math.PI*2);
var firing=Math.max(0,Math.sin(firePhase));
var coreAlpha=(0.2+firing*0.5)*nodeAlpha;
var coreR=nodeR*(0.8+firing*0.4);

ctx.beginPath();ctx.arc(jx,jy,coreR,0,Math.PI*2);
var coreGrad=ctx.createRadialGradient(jx,jy,0,jx,jy,coreR);
coreGrad.addColorStop(0,'rgba(255,255,255,'+(coreAlpha*0.8)+')');
coreGrad.addColorStop(0.5,'rgba('+aRGB+','+(coreAlpha)+')');
coreGrad.addColorStop(1,'rgba('+aRGB+','+(coreAlpha*0.3)+')');
ctx.fillStyle=coreGrad;ctx.fill();

// === NUCLEUS ===
ctx.beginPath();ctx.arc(jx,jy,coreR*0.3,0,Math.PI*2);
ctx.fillStyle='rgba(255,255,255,'+(coreAlpha*0.6)+')';ctx.fill();

// === DENDRITIC ARBOR ===
if(p.branchDepth>0&&nodeAlpha>0.05){
// Use seeded pseudo-random for consistent branches
var branchSeed=ni*1000+phase*100;
Math.random=function(){branchSeed=(branchSeed*16807)%2147483647;return(branchSeed-1)/2147483646};

var branches=4+Math.floor(node.r*3);
for(var bi=0;bi<branches;bi++){
var bAngle=(bi/branches)*Math.PI*2+ni*0.5;
var bLen=nodeR*1.5+node.r*10;
drawDendrite(jx,jy,bAngle,bLen,p.branchDepth,0.12*nodeAlpha,p);
}
Math.random=savedRandom;
}

// === NODE LABEL (very subtle) ===
if(nodeAlpha>0.15){
ctx.font='10px monospace';ctx.textAlign='center';
ctx.fillStyle='rgba('+aRGB+','+(nodeAlpha*0.25)+')';
ctx.fillText(node.name,jx,jy+nodeR*3+12);
}

// === FIRE AN ACTION POTENTIAL occasionally ===
if(firing>0.95&&Math.random()<p.fireRate*0.15){
// Find a connection from this node
for(var fc=0;fc<DMN_CONNECTIONS.length;fc++){
if(DMN_CONNECTIONS[fc][0]===ni||DMN_CONNECTIONS[fc][1]===ni){
if(Math.random()<0.3)fireAP(fc,p);break;
}}}
}

// === ACTION POTENTIALS IN TRANSIT ===
for(var api=actionPotentials.length-1;api>=0;api--){
var ap=actionPotentials[api];
ap.progress+=ap.speed;
if(ap.progress>1){actionPotentials.splice(api,1);continue;}
var fromN=DMN_NODES[ap.from],toN=DMN_NODES[ap.to];
var ax=fromN.x*W+(toN.x*W-fromN.x*W)*ap.progress;
var ay=fromN.y*H+(toN.y*H-fromN.y*H)*ap.progress;
// Curve offset
var ci2=ap.from*13+ap.to*7;
var midOff=Math.sin(ci2*2.3)*30;
var t2=ap.progress;
var curveX=(1-t2)*(1-t2)*fromN.x*W+2*(1-t2)*t2*((fromN.x*W+toN.x*W)/2+midOff)+t2*t2*toN.x*W;
var curveY=(1-t2)*(1-t2)*fromN.y*H+2*(1-t2)*t2*((fromN.y*H+toN.y*H)/2+Math.cos(ci2*1.7)*20)+t2*t2*toN.y*H;

var apAlpha=Math.sin(ap.progress*Math.PI)*0.9; // fade in and out
// Bright leading edge
var apG=ctx.createRadialGradient(curveX,curveY,0,curveX,curveY,12);
apG.addColorStop(0,'rgba(255,255,255,'+apAlpha+')');
apG.addColorStop(0.3,'rgba('+aRGB+','+(apAlpha*0.7)+')');
apG.addColorStop(1,'rgba(0,0,0,0)');
ctx.fillStyle=apG;ctx.beginPath();ctx.arc(curveX,curveY,12,0,Math.PI*2);ctx.fill();
// Core
ctx.beginPath();ctx.arc(curveX,curveY,2.5,0,Math.PI*2);
ctx.fillStyle='rgba(255,255,255,'+apAlpha+')';ctx.fill();
// Trail
for(var trail=1;trail<=6;trail++){
var tp2=Math.max(0,ap.progress-trail*0.03);
var tx=(1-tp2)*(1-tp2)*fromN.x*W+2*(1-tp2)*tp2*((fromN.x*W+toN.x*W)/2+midOff)+tp2*tp2*toN.x*W;
var ty=(1-tp2)*(1-tp2)*fromN.y*H+2*(1-tp2)*tp2*((fromN.y*H+toN.y*H)/2+Math.cos(ci2*1.7)*20)+tp2*tp2*toN.y*H;
ctx.beginPath();ctx.arc(tx,ty,2-trail*0.25,0,Math.PI*2);
ctx.fillStyle='rgba('+aRGB+','+(apAlpha*(1-trail/7)*0.4)+')';ctx.fill();
}}

// === DISSOLUTION PARTICLES — network fragmenting ===
if(p.dissolution>0.05){
var partCount=Math.floor(p.dissolution*150);
for(var dp=0;dp<partCount;dp++){
var dx=cx+Math.sin(dp*4.7+t*0.001)*W*0.5;
var dy=cy+Math.cos(dp*3.1+t*0.0008)*H*0.45;
var drift=t*0.0003;
dx+=Math.sin(drift+dp)*40*p.dissolution;
dy+=Math.cos(drift+dp*0.7)*30*p.dissolution;
var ds=0.5+Math.sin(dp*1.3+t*0.003)*1.5;
if(ds>0){
ctx.beginPath();ctx.arc(dx,dy,ds,0,Math.PI*2);
ctx.fillStyle='rgba('+aRGB+','+(0.05+p.dissolution*0.15)+')';ctx.fill();
}}}

// === SELF-NARRATIVE WHISPERS ===
if(p.txt.length>0){
ctx.font=Math.round(Math.min(16,W*0.025))+'px monospace';ctx.textAlign='center';
for(var ti=0;ti<p.txt.length;ti++){
var tx=cx+Math.sin(ti*2.1+t*0.0004)*W*0.32*(1-p.dissolution*0.8);
var ty=cy+Math.cos(ti*1.7+t*0.0003)*H*0.25*(1-p.dissolution*0.8);
var ta=0.15*(1-p.dissolution)*(0.5+Math.sin(t*0.001+ti*1.5)*0.5);
if(ta>0.01){ctx.fillStyle='rgba('+aRGB+','+ta+')';ctx.fillText(p.txt[ti],tx,ty);}
}}

// === HUD CORNER BRACKETS ===
var bL=35,bA=0.15*(1-p.dissolution*0.5);
ctx.strokeStyle='rgba('+aRGB+','+bA+')';ctx.lineWidth=0.8;
ctx.beginPath();ctx.moveTo(8,8+bL);ctx.lineTo(8,8);ctx.lineTo(8+bL,8);ctx.stroke();
ctx.beginPath();ctx.moveTo(W-8-bL,8);ctx.lineTo(W-8,8);ctx.lineTo(W-8,8+bL);ctx.stroke();
ctx.beginPath();ctx.moveTo(8,H-8-bL);ctx.lineTo(8,H-8);ctx.lineTo(8+bL,H-8);ctx.stroke();
ctx.beginPath();ctx.moveTo(W-8-bL,H-8);ctx.lineTo(W-8,H-8);ctx.lineTo(W-8,H-8-bL);ctx.stroke();

// === USER PROXIMITY — nodes react to cursor/finger ===
hoveredNode=-1;
if(mouseX>0&&mouseY>0){
// Draw user presence indicator — faint ripple at cursor
var userG=ctx.createRadialGradient(mouseX,mouseY,0,mouseX,mouseY,60);
userG.addColorStop(0,'rgba(255,255,255,0.03)');
userG.addColorStop(0.5,'rgba('+aRGB+',0.02)');
userG.addColorStop(1,'rgba(0,0,0,0)');
ctx.fillStyle=userG;ctx.beginPath();ctx.arc(mouseX,mouseY,60,0,Math.PI*2);ctx.fill();

// Check proximity to each node
for(var ui=0;ui<DMN_NODES.length;ui++){
var un=DMN_NODES[ui];
var unx=un.x*W,uny=un.y*H;
var udist=Math.sqrt((mouseX-unx)*(mouseX-unx)+(mouseY-uny)*(mouseY-uny));
var proxThresh=W*0.1;

if(udist<proxThresh){
var proxStrength=1-udist/proxThresh;
hoveredNode=ui;

// Node REACTS — brightens, pulses harder
var reactG=ctx.createRadialGradient(unx,uny,0,unx,uny,30+proxStrength*40);
reactG.addColorStop(0,'rgba(255,255,255,'+(proxStrength*0.2)+')');
reactG.addColorStop(0.4,'rgba('+aRGB+','+(proxStrength*0.15)+')');
reactG.addColorStop(1,'rgba(0,0,0,0)');
ctx.fillStyle=reactG;ctx.beginPath();ctx.arc(unx,uny,30+proxStrength*40,0,Math.PI*2);ctx.fill();

// Dendrites REACH toward the cursor
var reachAngle=Math.atan2(mouseY-uny,mouseX-unx);
ctx.beginPath();ctx.moveTo(unx,uny);
var rMid=udist*0.5;
ctx.quadraticCurveTo(unx+Math.cos(reachAngle)*rMid,uny+Math.sin(reachAngle)*rMid,mouseX,mouseY);
ctx.strokeStyle='rgba('+aRGB+','+(proxStrength*0.1)+')';ctx.lineWidth=0.8;ctx.stroke();
// Tiny sparks along the reaching dendrite
for(var rk=0;rk<5;rk++){
var rkP=rk/5;
var rkX=unx+(mouseX-unx)*rkP+Math.sin(t*0.01+rk)*4;
var rkY=uny+(mouseY-uny)*rkP+Math.cos(t*0.01+rk)*4;
if(Math.random()<proxStrength*0.3){
ctx.beginPath();ctx.arc(rkX,rkY,1.5,0,Math.PI*2);
ctx.fillStyle='rgba(255,255,255,'+(proxStrength*0.4)+')';ctx.fill();
}}

// Highlight connected fiber tracts
for(var hc=0;hc<DMN_CONNECTIONS.length;hc++){
var hconn=DMN_CONNECTIONS[hc];
if(hconn[0]===ui||hconn[1]===ui){
var hn1=DMN_NODES[hconn[0]],hn2=DMN_NODES[hconn[1]];
var hx1=hn1.x*W,hy1=hn1.y*H,hx2=hn2.x*W,hy2=hn2.y*H;
var hmX=(hx1+hx2)/2+Math.sin(hc*2.3)*30;
var hmY=(hy1+hy2)/2+Math.cos(hc*1.7)*20;
ctx.beginPath();ctx.moveTo(hx1,hy1);ctx.quadraticCurveTo(hmX,hmY,hx2,hy2);
ctx.strokeStyle='rgba('+aRGB+','+(proxStrength*0.25)+')';ctx.lineWidth=2;ctx.stroke();
}}

// Fire extra APs from proximity
if(Math.random()<proxStrength*0.08){
for(var pfc=0;pfc<DMN_CONNECTIONS.length;pfc++){
if((DMN_CONNECTIONS[pfc][0]===ui||DMN_CONNECTIONS[pfc][1]===ui)&&Math.random()<0.2){
fireAP(pfc,p);break;}}}

// Show node name on hover
ctx.font='14px monospace';ctx.textAlign='center';
ctx.fillStyle='rgba('+aRGB+','+(proxStrength*0.7)+')';
ctx.fillText(un.name,unx,uny-35-proxStrength*10);
// Show function
ctx.font='11px monospace';
ctx.fillStyle='rgba('+aRGB+','+(proxStrength*0.45)+')';
var info=NODE_INFO[un.name];
if(info)ctx.fillText(info.fn,unx,uny-20-proxStrength*10);

break;// only one hovered node
}}}

// === TAPPED NODE INFO PANEL ===
if(tappedNode>=0&&tapFade>0){
tapFade-=0.003;
if(tapFade<=0){tappedNode=-1;tapFade=0;}
else{
var tn=DMN_NODES[tappedNode];
var tnInfo=NODE_INFO[tn.name];
if(tnInfo){
var isMobile=W<600;
var fontSize=isMobile?13:14;
var titleSize=isMobile?18:20;
var popSize=isMobile?12:13;
var lineH=isMobile?22:24;
var padding=isMobile?14:16;
var popLines=tnInfo.pop.split('\n');
var hasPhase7=phase===7&&tnInfo.phase7;
var panelW=Math.min(isMobile?W*0.88:420,W*0.6);

// ── PASS 1: Measure actual content height ──
var measuredH=0;
measuredH+=titleSize+10;// node name
measuredH+=fontSize+8;// function
// Description — check if wraps
ctx.font=fontSize+'px Georgia';
if(isMobile&&ctx.measureText(tnInfo.desc).width>panelW){
  var wds=tnInfo.desc.split(' '),ln='',wrapLines=0;
  for(var wi=0;wi<wds.length;wi++){
    var tl=ln+(ln?' ':'')+wds[wi];
    if(ctx.measureText(tl).width>panelW&&ln){wrapLines++;ln=wds[wi];}
    else{ln=tl;}
  }
  if(ln)wrapLines++;
  measuredH+=wrapLines*(fontSize+3)+4;
}else{measuredH+=fontSize+6;}
measuredH+=14;// divider + gap
// Pop lines — check each for overflow
ctx.font=popSize+'px monospace';
for(var pl=0;pl<popLines.length;pl++){
  if(isMobile&&ctx.measureText(popLines[pl]).width>panelW){
    measuredH+=lineH+popSize;// wrapped line takes more
  }else{measuredH+=lineH;}
}
if(hasPhase7)measuredH+=lineH+4;
var panelH=measuredH+padding;

// ── Position panel ──
var panelX,panelY;
if(isMobile){
  panelX=Math.max(6,Math.min(W-panelW-6,(tn.x*W)-panelW/2));
  panelY=Math.max(6,Math.min(H-panelH-padding*2-6,tn.y*H+35));
  if(tn.y>0.45)panelY=Math.max(6,tn.y*H-panelH-padding*2-35);
}else{
  panelX=tn.x<0.5?Math.min(W-panelW-20,W*0.55):Math.max(20,W*0.45-panelW);
  panelY=Math.max(70,Math.min(H-panelH-padding*2-20,tn.y*H-panelH/2));
}
var pAlpha=Math.min(tapFade,0.85);

// ── PASS 2: Draw box at measured size ──
ctx.fillStyle='rgba(0,0,0,'+(pAlpha*0.93)+')';
ctx.strokeStyle='rgba('+aRGB+','+(pAlpha*0.4)+')';ctx.lineWidth=1;
ctx.beginPath();ctx.rect(panelX-padding,panelY-padding,panelW+padding*2,panelH+padding*2);ctx.fill();ctx.stroke();
ctx.strokeStyle='rgba('+aRGB+','+(pAlpha*0.1)+')';ctx.lineWidth=0.5;
ctx.beginPath();ctx.rect(panelX-padding/2,panelY-padding/2,panelW+padding,panelH+padding);ctx.stroke();

// Connection line
ctx.beginPath();ctx.moveTo(tn.x*W,tn.y*H);
var lineTarget=panelY>tn.y*H?panelY:panelY+panelH+padding*2;
ctx.lineTo(panelX+panelW/2,lineTarget);
ctx.strokeStyle='rgba('+aRGB+','+(pAlpha*0.2)+')';ctx.lineWidth=0.8;ctx.stroke();

// ── PASS 3: Render text content ──
var yOff=panelY;
ctx.textAlign='left';

// Node name
ctx.font='bold '+titleSize+'px monospace';
ctx.fillStyle='rgba('+aRGB+','+(pAlpha)+')';
ctx.fillText(tn.name,panelX,yOff+titleSize);yOff+=titleSize+10;

// Function
ctx.font=fontSize+'px monospace';
ctx.fillStyle='rgba(255,255,255,'+(pAlpha*0.8)+')';
ctx.fillText(tnInfo.fn,panelX,yOff+fontSize);yOff+=fontSize+8;

// Description with word wrap
ctx.font=fontSize+'px Georgia';
ctx.fillStyle='rgba(255,255,255,'+(pAlpha*0.55)+')';
if(isMobile&&ctx.measureText(tnInfo.desc).width>panelW){
  var words=tnInfo.desc.split(' '),line='';
  for(var wi=0;wi<words.length;wi++){
    var testLine=line+(line?' ':'')+words[wi];
    if(ctx.measureText(testLine).width>panelW&&line){
      ctx.fillText(line,panelX,yOff+fontSize);yOff+=fontSize+3;
      line=words[wi];
    }else{line=testLine;}
  }
  if(line){ctx.fillText(line,panelX,yOff+fontSize);yOff+=fontSize+4;}
}else{
  ctx.fillText(tnInfo.desc,panelX,yOff+fontSize);yOff+=fontSize+6;
}

// Divider
yOff+=4;
ctx.beginPath();ctx.moveTo(panelX,yOff);ctx.lineTo(panelX+panelW,yOff);
ctx.strokeStyle='rgba('+aRGB+','+(pAlpha*0.15)+')';ctx.lineWidth=0.5;ctx.stroke();
yOff+=10;

// Population info with overflow handling
ctx.font=popSize+'px monospace';
for(var pl=0;pl<popLines.length;pl++){
var colonIdx=popLines[pl].indexOf(':');
if(colonIdx>0){
  ctx.fillStyle='rgba('+aRGB+','+(pAlpha*0.7)+')';
  var condText=popLines[pl].substring(0,colonIdx+1);
  ctx.fillText(condText,panelX,yOff+popSize);
  ctx.fillStyle='rgba(255,255,255,'+(pAlpha*0.45)+')';
  var detailText=popLines[pl].substring(colonIdx+1);
  var condW=ctx.measureText(condText).width+3;
  // Wrap detail text if needed on mobile
  if(isMobile&&ctx.measureText(detailText).width>panelW-condW){
    // Truncate smartly at word boundary
    var maxW=panelW-condW;
    var trimmed='';
    var dWords=detailText.trim().split(' ');
    for(var dw=0;dw<dWords.length;dw++){
      var test=trimmed+(trimmed?' ':'')+dWords[dw];
      if(ctx.measureText(test).width>maxW){
        if(!trimmed)trimmed=dWords[dw];
        ctx.fillText(trimmed,panelX+condW,yOff+popSize);
        yOff+=popSize+3;
        trimmed=dWords.slice(dw).join(' ');
        if(ctx.measureText(trimmed).width>panelW)trimmed=trimmed.substring(0,Math.floor(panelW/(popSize*0.6)))+'…';
        ctx.fillText(trimmed,panelX+4,yOff+popSize);
        trimmed='';break;
      }else{trimmed=test;}
    }
    if(trimmed)ctx.fillText(trimmed,panelX+condW,yOff+popSize);
  }else{
    ctx.fillText(detailText,panelX+condW,yOff+popSize);
  }
}else{
  ctx.fillStyle='rgba('+aRGB+','+(pAlpha*0.5)+')';
  ctx.fillText(popLines[pl],panelX,yOff+popSize);
}
yOff+=lineH;
}

// Phase 7 warning
if(hasPhase7){
ctx.font='bold '+(isMobile?14:16)+'px monospace';
ctx.fillStyle='rgba(255,60,60,'+(pAlpha*0.85)+')';
ctx.fillText('\u26a0 '+tnInfo.phase7,panelX,yOff+12);
}

// Pulse ring
var pulseExpand=1-tapFade;
ctx.beginPath();ctx.arc(tn.x*W,tn.y*H,20+pulseExpand*80,0,Math.PI*2);
ctx.strokeStyle='rgba(255,255,255,'+(tapFade*0.15)+')';ctx.lineWidth=1.5;ctx.stroke();
}}}

// === SCANNING CROSSHAIR at center (subtle) ===
var chA=0.04*(1-p.dissolution);
if(chA>0.005){
ctx.strokeStyle='rgba('+aRGB+','+chA+')';ctx.lineWidth=0.5;
ctx.beginPath();ctx.moveTo(cx-25,cy);ctx.lineTo(cx-8,cy);ctx.stroke();
ctx.beginPath();ctx.moveTo(cx+8,cy);ctx.lineTo(cx+25,cy);ctx.stroke();
ctx.beginPath();ctx.moveTo(cx,cy-25);ctx.lineTo(cx,cy-8);ctx.stroke();
ctx.beginPath();ctx.moveTo(cx,cy+8);ctx.lineTo(cx,cy+25);ctx.stroke();
}

t+=16;requestAnimationFrame(draw)}

// KEYBOARD NAV
document.addEventListener('keydown',function(e){
if(e.key==='ArrowRight'&&phase<10&&isUnlocked(phase+1))setPhase(phase+1);
if(e.key==='ArrowLeft'&&phase>0)setPhase(phase-1);});

// MOUSE TRACKING
canvas.addEventListener('mousemove',function(e){mouseX=e.clientX;mouseY=e.clientY});
canvas.addEventListener('mouseleave',function(){mouseX=-1;mouseY=-1;hoveredNode=-1});
canvas.addEventListener('click',function(e){
mouseX=e.clientX;mouseY=e.clientY;
// Check if near a node
for(var ni=0;ni<DMN_NODES.length;ni++){
var nd=DMN_NODES[ni],ndx=nd.x*W,ndy=nd.y*H;
var dist=Math.sqrt((mouseX-ndx)*(mouseX-ndx)+(mouseY-ndy)*(mouseY-ndy));
if(dist<W*0.06){tappedNode=ni;tapFade=1;
// Fire action potentials from tapped node
for(var fc=0;fc<DMN_CONNECTIONS.length;fc++){
if(DMN_CONNECTIONS[fc][0]===ni||DMN_CONNECTIONS[fc][1]===ni)fireAP(fc,PH[phase]);}
return;}}
tappedNode=-1;tapFade=0;
});

// TOUCH TRACKING
var touchStartX=0,touchStartY=0,touchStartTime=0;
canvas.addEventListener('touchstart',function(e){
var t2=e.touches[0];touchStartX=t2.clientX;touchStartY=t2.clientY;touchStartTime=Date.now();
mouseX=t2.clientX;mouseY=t2.clientY;touchActive=true;
},{passive:true});
canvas.addEventListener('touchmove',function(e){
mouseX=e.touches[0].clientX;mouseY=e.touches[0].clientY;
},{passive:true});
canvas.addEventListener('touchend',function(e){
var dx=e.changedTouches[0].clientX-touchStartX;
var dy=e.changedTouches[0].clientY-touchStartY;
var dt=Date.now()-touchStartTime;
// Swipe nav (long horizontal swipe)
if(Math.abs(dx)>60&&Math.abs(dx)>Math.abs(dy)*2&&dt<500){
if(dx<-60&&phase<10&&isUnlocked(phase+1))setPhase(phase+1);
if(dx>60&&phase>0)setPhase(phase-1);
}
// Tap (short press, small movement)
else if(dt<300&&Math.abs(dx)<20&&Math.abs(dy)<20){
var tx=e.changedTouches[0].clientX,ty=e.changedTouches[0].clientY;
for(var ni=0;ni<DMN_NODES.length;ni++){
var nd=DMN_NODES[ni],ndx=nd.x*W,ndy=nd.y*H;
var dist2=Math.sqrt((tx-ndx)*(tx-ndx)+(ty-ndy)*(ty-ndy));
if(dist2<W*0.08){tappedNode=ni;tapFade=1;
for(var fc=0;fc<DMN_CONNECTIONS.length;fc++){
if(DMN_CONNECTIONS[fc][0]===ni||DMN_CONNECTIONS[fc][1]===ni)fireAP(fc,PH[phase]);}
break;}}
}
setTimeout(function(){mouseX=-1;mouseY=-1;touchActive=false},100);
});

// ═══════════════════════════════════════════════
// IMMERSIVE PHASE EXPERIENCE SYSTEM
// You become a neuron. The DMN morphs around you.
// ═══════════════════════════════════════════════

// Phase experience data — what each phase feels like from inside
var PHASE_EXP={
0:{ // SOURCE — you are a neuron in the mPFC
  focusNode:0, // mPFC
  title:"YOU ARE A NEURON IN THE MEDIAL PREFRONTAL CORTEX",
  sequence:[
    {at:0,  narr:"INITIALIZING FIRST-PERSON PERSPECTIVE",src:""},
    {at:3,  narr:"YOU EXIST AT THE CENTER OF THE DEFAULT MODE NETWORK",src:"mPFC · BRODMANN AREAS 10, 32"},
    {at:8,  narr:"YOUR JOB: INTEGRATE EVERY INPUT INTO A COHERENT SELF",src:"SELF-REFERENTIAL PROCESSING"},
    {at:14, narr:"SIGNAL ARRIVING FROM HIPPOCAMPUS",src:"MEMORY FRAGMENT · EPISODIC RECALL",input:"hippo",word:"I REMEMBER"},
    {at:20, narr:"SIGNAL ARRIVING FROM AMYGDALA",src:"EMOTIONAL VALENCE · THREAT ASSESSMENT",input:"amyg",word:"I FEAR"},
    {at:26, narr:"SIGNAL ARRIVING FROM INSULA",src:"INTEROCEPTIVE STATE · BODY MAP",input:"insula",word:"I FEEL"},
    {at:32, narr:"SIGNAL ARRIVING FROM TEMPOROPARIETAL JUNCTION",src:"SOCIAL PREDICTION · THEORY OF MIND",input:"tpj",word:"I PREDICT"},
    {at:38, narr:"SIGNAL ARRIVING FROM POSTERIOR CINGULATE",src:"AUTOBIOGRAPHICAL MEMORY · SELF-CONTINUITY",input:"pcc",word:"I ALWAYS"},
    {at:44, narr:"ALL INPUTS CONVERGING",src:"INTEGRATION THRESHOLD REACHED",word:"I AM"},
    {at:50, narr:"THIS IS YOUR DEFAULT MODE",src:"THIS NARRATIVE RUNS WHEN NOTHING ELSE DOES"},
    {at:56, narr:"YOU ARE THE STORY YOUR BRAIN TELLS ITSELF ABOUT ITSELF",src:""},
    {at:62, narr:"THE QUESTION IS — IS THE STORY TRUE",src:"PHASE 0 · SOURCE · COMPLETE"},
    {at:68, narr:"",src:""},
  ],
  inputs:{
    hippo:{angle:Math.PI*0.8, color:[120,180,140], label:"HIPPOCAMPUS"},
    amyg:{angle:Math.PI*1.3, color:[200,80,80], label:"AMYGDALA"},
    insula:{angle:Math.PI*0.3, color:[160,120,200], label:"INSULA"},
    tpj:{angle:Math.PI*1.7, color:[100,160,220], label:"TPJ"},
    pcc:{angle:Math.PI*0.0, color:[180,160,100], label:"PCC"},
  }
},
1:{ // LIGHT — salience network fires, pattern interrupt
  focusNode:5, // dACC (salience hub)
  title:"YOU ARE A NEURON IN THE ANTERIOR CINGULATE",
  sequence:[
    {at:0,  narr:"PERSPECTIVE SHIFT: SALIENCE NETWORK",src:""},
    {at:3,  narr:"YOU ARE THE ALARM SYSTEM",src:"dACC · DORSAL ANTERIOR CINGULATE"},
    {at:8,  narr:"YOUR JOB: DETECT WHEN SOMETHING DOESN'T MATCH",src:"CONFLICT MONITORING · ERROR DETECTION"},
    {at:13, narr:"DEFAULT MODE IS RUNNING — EVERYTHING PREDICTED",src:"mPFC SIGNAL: STABLE",input:"mpfc_stable",word:"PATTERN"},
    {at:18, narr:"INCOMING: ANOMALY DETECTED",src:"PREDICTION ERROR · MISMATCH SIGNAL",input:"anomaly",word:"WAIT"},
    {at:23, narr:"YOU FIRE — HARD — SALIENCE SPIKE",src:"NOREPINEPHRINE SURGE · ATTENTION REDIRECT",word:"WHAT IS THIS"},
    {at:28, narr:"THE DEFAULT NARRATIVE STUTTERS",src:"mPFC SUPPRESSED BY dACC OUTPUT",input:"suppress",word:"THE WALL"},
    {at:33, narr:"AMYGDALA WANTS TO KNOW: THREAT?",src:"THREAT ASSESSMENT REQUEST",input:"amyg_query",word:"WHO BUILT IT"},
    {at:38, narr:"YOU DON'T ANSWER — YOU JUST POINT",src:"SALIENCE IS NOT JUDGMENT — IT IS ATTENTION"},
    {at:43, narr:"SOMETHING IN THE PATTERN WAS WRONG",src:"THE FIRST CRACK IN THE NARRATIVE"},
    {at:48, narr:"EVERY TRANSFORMATION BEGINS WITH NOTICING",src:"PHASE 1 · LIGHT · COMPLETE"},
    {at:54, narr:"",src:""},
  ],
  inputs:{
    mpfc_stable:{angle:Math.PI*0.0, color:[160,170,180], label:"mPFC"},
    anomaly:{angle:Math.PI*1.2, color:[255,230,80], label:"SENSORY CORTEX"},
    suppress:{angle:Math.PI*0.0, color:[255,100,100], label:"→ mPFC INHIBIT"},
    amyg_query:{angle:Math.PI*1.5, color:[200,80,80], label:"AMYGDALA"},
  }
},
2:{ // RHYTHM — oxytocin, vagal sync, co-regulation
  focusNode:4, // right TPJ (social)
  title:"YOU ARE A NEURON IN THE TEMPOROPARIETAL JUNCTION",
  sequence:[
    {at:0,  narr:"PERSPECTIVE SHIFT: SOCIAL BRAIN",src:""},
    {at:3,  narr:"YOU ARE WHERE SELF MEETS OTHER",src:"rTPJ · RIGHT TEMPOROPARIETAL JUNCTION"},
    {at:8,  narr:"YOUR JOB: MODEL ANOTHER MIND",src:"THEORY OF MIND · MENTALIZING"},
    {at:13, narr:"MIRROR NEURON SIGNAL: THEY MOVED",src:"PREMOTOR CORTEX · ACTION OBSERVATION",input:"mirror",word:"YOU"},
    {at:18, narr:"VAGAL AFFERENT: YOUR HEART RATE SHIFTED",src:"NUCLEUS TRACTUS SOLITARIUS · VAGAL TONE",input:"vagal",word:"SYNC"},
    {at:23, narr:"OXYTOCIN RECEPTOR ACTIVATION",src:"HYPOTHALAMUS · PAIR BONDING SIGNAL",input:"oxy",word:"TOGETHER"},
    {at:28, narr:"YOUR FIRING RATE ENTRAINS TO THEIRS",src:"NEURAL COUPLING · INTERPERSONAL SYNCHRONY"},
    {at:33, narr:"TWO NERVOUS SYSTEMS BECOMING ONE CIRCUIT",src:"DYADIC CO-REGULATION"},
    {at:38, narr:"THE BOUNDARY BETWEEN SELF AND OTHER THINS",src:"INSULA INTEGRATION · SHARED INTEROCEPTION",input:"insula_share",word:"WE ARE"},
    {at:43, narr:"ISOLATION IS A NEURAL STATE — SO IS CONNECTION",src:"POLYVAGAL THEORY · VENTRAL VAGAL"},
    {at:48, narr:"YOU WERE NEVER MEANT TO REGULATE ALONE",src:"PHASE 2 · RHYTHM · COMPLETE"},
    {at:54, narr:"",src:""},
  ],
  inputs:{
    mirror:{angle:Math.PI*1.3, color:[180,200,160], label:"MIRROR SYSTEM"},
    vagal:{angle:Math.PI*0.7, color:[100,180,200], label:"VAGUS NERVE"},
    oxy:{angle:Math.PI*0.2, color:[220,160,180], label:"HYPOTHALAMUS"},
    insula_share:{angle:Math.PI*1.8, color:[160,120,200], label:"INSULA"},
  }
},
3:{ // DARKNESS — amygdala flood, shadow access
  focusNode:6, // amygdala position (using AG_L)
  title:"YOU ARE A NEURON IN THE BASOLATERAL AMYGDALA",
  sequence:[
    {at:0,  narr:"PERSPECTIVE SHIFT: THREAT PROCESSING",src:""},
    {at:3,  narr:"YOU ARE THE OLDEST PART OF THE FEAR CIRCUIT",src:"BLA · BASOLATERAL AMYGDALA"},
    {at:8,  narr:"YOUR JOB: ENCODE WHAT MUST NEVER HAPPEN AGAIN",src:"FEAR CONDITIONING · AVERSIVE MEMORY"},
    {at:13, narr:"THALAMIC RELAY: RAW SENSORY — NO CORTEX",src:"LOW ROAD · 12ms RESPONSE",input:"thalamus",word:"DANGER"},
    {at:18, narr:"YOU FIRE BEFORE CONSCIOUSNESS ARRIVES",src:"SUBCORTICAL THREAT DETECTION"},
    {at:23, narr:"CRF RELEASE: STRESS AXIS ACTIVATING",src:"HPA AXIS · CORTISOL CASCADE",input:"hpa",word:"AFRAID"},
    {at:28, narr:"mPFC TRYING TO INHIBIT YOU — BUT YOU'RE FASTER",src:"TOP-DOWN REGULATION FAILING",input:"mpfc_fail",word:"REFUSED"},
    {at:33, narr:"THIS IS WHAT TRAUMA LOOKS LIKE FROM INSIDE",src:"AMYGDALA HYPERACTIVATION · PREFRONTAL HYPOFUNCTION"},
    {at:38, narr:"EVERY SUPPRESSED MEMORY IS STILL ENCODED IN YOU",src:"IMPLICIT MEMORY · SOMATIC STORAGE",word:"BURIED"},
    {at:43, narr:"THE SHADOW IS NOT DARKNESS — IT IS SIGNAL WITHOUT PROCESSING",src:"VAN DER KOLK · THE BODY KEEPS THE SCORE"},
    {at:48, narr:"TO HEAL IS NOT TO FORGET — IT IS TO INTEGRATE",src:"PHASE 3 · DARKNESS · COMPLETE"},
    {at:54, narr:"",src:""},
  ],
  inputs:{
    thalamus:{angle:Math.PI*0.5, color:[255,120,60], label:"THALAMUS"},
    hpa:{angle:Math.PI*1.0, color:[200,60,60], label:"HPA AXIS"},
    mpfc_fail:{angle:Math.PI*0.0, color:[100,100,120], label:"mPFC (WEAK)"},
  }
},
4:{ // PEACE — vagal lock, GABA, parasympathetic
  focusNode:1, // PCC (rest state hub)
  title:"YOU ARE A NEURON IN THE VENTRAL VAGAL COMPLEX",
  sequence:[
    {at:0,  narr:"PERSPECTIVE SHIFT: AUTONOMIC REGULATION",src:""},
    {at:3,  narr:"YOU ARE THE BRAKE PEDAL OF THE NERVOUS SYSTEM",src:"NUCLEUS AMBIGUUS · VENTRAL VAGAL"},
    {at:8,  narr:"YOUR JOB: SLOW EVERYTHING DOWN",src:"PARASYMPATHETIC DOMINANCE · GABA TONE"},
    {at:13, narr:"GABA RECEPTOR BINDING: INHIBITION SPREADING",src:"INHIBITORY INTERNEURON CASCADE",input:"gaba",word:"STILL"},
    {at:18, narr:"HEART RATE DROPPING — RESPIRATORY SINUS ARRHYTHMIA",src:"CARDIORESPIRATORY COUPLING",input:"cardio",word:"SAFE"},
    {at:23, narr:"CORTISOL CLEARING — HPA AXIS STANDING DOWN",src:"GLUCOCORTICOID NEGATIVE FEEDBACK"},
    {at:28, narr:"AMYGDALA OUTPUT DAMPENED BY PREFRONTAL GABA",src:"TOP-DOWN INHIBITION RESTORED",input:"amyg_quiet",word:"REST"},
    {at:33, narr:"THE BODY CANNOT HEAL IN SYMPATHETIC OVERDRIVE",src:"PORGES · NEUROCEPTION OF SAFETY"},
    {at:38, narr:"THIS STATE IS NOT WEAKNESS — IT IS RESTORATION",src:"GLYMPHATIC CLEARANCE · SYNAPTIC HOMEOSTASIS"},
    {at:43, narr:"EVERY CELL IN YOUR BODY IS WAITING FOR THIS SIGNAL",src:"PHASE 4 · PEACE · COMPLETE"},
    {at:49, narr:"",src:""},
  ],
  inputs:{
    gaba:{angle:Math.PI*1.2, color:[100,200,120], label:"GABA INTERNEURONS"},
    cardio:{angle:Math.PI*0.6, color:[100,150,200], label:"VAGUS → HEART"},
    amyg_quiet:{angle:Math.PI*1.7, color:[180,80,80], label:"AMYGDALA (FADING)"},
  }
},
5:{ // ENDURANCE — hormetic stress, BDNF, strengthening
  focusNode:7, // using vmPFC position for hypothalamus proxy
  title:"YOU ARE A NEURON IN THE LOCUS COERULEUS",
  sequence:[
    {at:0,  narr:"PERSPECTIVE SHIFT: STRESS INOCULATION",src:""},
    {at:3,  narr:"YOU ARE THE NOREPINEPHRINE FOUNTAIN",src:"LC · LOCUS COERULEUS · PONTINE BRAINSTEM"},
    {at:8,  narr:"YOUR JOB: DOSE THE BRAIN WITH CONTROLLED STRESS",src:"HORMESIS · WHAT DOESN'T KILL YOU"},
    {at:13, narr:"COLD SIGNAL: THERMORECEPTORS FIRING",src:"A-DELTA FIBERS · ACUTE STRESSOR",input:"cold",word:"HOLD"},
    {at:18, narr:"YOU RELEASE NOREPINEPHRINE — EVERYWHERE",src:"GLOBAL NEUROMODULATION · AROUSAL SURGE",word:"BEND"},
    {at:23, narr:"BDNF EXPRESSION ACTIVATED IN HIPPOCAMPUS",src:"BRAIN-DERIVED NEUROTROPHIC FACTOR",input:"bdnf",word:"GROW"},
    {at:28, narr:"SYNAPSES STRENGTHENING UNDER LOAD",src:"LONG-TERM POTENTIATION · HEBBIAN LEARNING"},
    {at:33, narr:"MITOCHONDRIAL BIOGENESIS TRIGGERED",src:"PGC-1α · CELLULAR ENERGY ADAPTATION",input:"mito",word:"STRONGER"},
    {at:38, narr:"THE NEURON THAT FIRES UNDER STRESS BUILDS MORE DENDRITES",src:"USE-DEPENDENT PLASTICITY"},
    {at:43, narr:"COMFORT NEVER BUILT ANYTHING",src:"PHASE 5 · ENDURANCE · COMPLETE"},
    {at:49, narr:"",src:""},
  ],
  inputs:{
    cold:{angle:Math.PI*1.4, color:[100,180,255], label:"THERMORECEPTORS"},
    bdnf:{angle:Math.PI*0.8, color:[120,200,100], label:"HIPPOCAMPUS"},
    mito:{angle:Math.PI*0.2, color:[255,160,50], label:"MITOCHONDRIA"},
  }
},
6:{ // ORDER — executive integration, dlPFC governance
  focusNode:8, // using DLPFC_L
  title:"YOU ARE A NEURON IN THE DORSOLATERAL PREFRONTAL CORTEX",
  sequence:[
    {at:0,  narr:"PERSPECTIVE SHIFT: EXECUTIVE CONTROL",src:""},
    {at:3,  narr:"YOU ARE THE ARCHITECT OF WORKING MEMORY",src:"dlPFC · BRODMANN AREAS 9, 46"},
    {at:8,  narr:"YOUR JOB: HOLD PATTERNS AND BUILD STRUCTURE",src:"COGNITIVE CONTROL · GOAL MAINTENANCE"},
    {at:13, narr:"PARIETAL INPUT: SPATIAL RELATIONSHIPS",src:"POSTERIOR PARIETAL · WHERE PATHWAY",input:"parietal",word:"MAP"},
    {at:18, narr:"BASAL GANGLIA: SEQUENCE SELECTION",src:"STRIATAL GATING · ACTION SELECTION",input:"bg",word:"STRUCTURE"},
    {at:23, narr:"ANTERIOR CINGULATE: CONFLICT RESOLVED",src:"ERROR SIGNAL CLEARED",input:"acc",word:"ORDER"},
    {at:28, narr:"YOU HOLD SEVEN ITEMS — PLUS OR MINUS TWO",src:"MILLER 1956 · WORKING MEMORY CAPACITY"},
    {at:33, narr:"DOPAMINE SUSTAINS YOUR FIRING — STABLE STATE",src:"D1 RECEPTOR · PERSISTENT ACTIVITY",word:"BUILD"},
    {at:38, narr:"CHAOS IS RAW MATERIAL — ORDER IS WHAT YOU MAKE OF IT",src:"EXECUTIVE FUNCTION · TOP-DOWN GOVERNANCE"},
    {at:43, narr:"WITHOUT YOU THE INSIGHTS MEAN NOTHING",src:"PHASE 6 · ORDER · COMPLETE"},
    {at:49, narr:"",src:""},
  ],
  inputs:{
    parietal:{angle:Math.PI*1.3, color:[100,140,220], label:"PARIETAL CORTEX"},
    bg:{angle:Math.PI*0.7, color:[200,160,80], label:"BASAL GANGLIA"},
    acc:{angle:Math.PI*0.0, color:[180,180,100], label:"ACC"},
  }
},
7:{ // SEPARATION — ego dissolution, mPFC goes offline
  focusNode:0, // mPFC — same as Phase 0 but it DIES
  title:"YOU ARE THE SAME NEURON FROM PHASE 0",
  sequence:[
    {at:0,  narr:"RETURN TO THE mPFC",src:""},
    {at:3,  narr:"YOU ARE THE SAME NEURON THAT SAID 'I AM'",src:"mPFC · THE SELF-NARRATIVE ENGINE"},
    {at:8,  narr:"BUT SOMETHING HAS CHANGED",src:"5-HT2A RECEPTOR ACTIVATION"},
    {at:13, narr:"SEROTONIN FLOOD — YOUR RECEPTORS ARE SATURATED",src:"PSILOCYBIN METABOLITE · PSILOCIN",input:"sero",word:"WHO"},
    {at:18, narr:"YOUR FIRING RATE IS DROPPING",src:"0.5Hz → 0.3Hz → 0.1Hz"},
    {at:23, narr:"THE INPUTS FROM PHASE 0 ARE STILL ARRIVING",src:"BUT YOU CAN NO LONGER BIND THEM",input:"frag1",word:"I..."},
    {at:28, narr:"HIPPOCAMPUS SIGNAL — UNPROCESSED",src:"MEMORY WITHOUT A SELF TO REMEMBER",input:"frag2",word:"..."},
    {at:33, narr:"YOUR CONNECTIONS ARE DISSOLVING",src:"DMN FUNCTIONAL CONNECTIVITY: 20% → 5%"},
    {at:38, narr:"THE STORY STOPS",src:"THERE IS NO I"},
    {at:43, narr:"THIS IS EGO DISSOLUTION",src:"CARHART-HARRIS · ENTROPIC BRAIN HYPOTHESIS"},
    {at:48, narr:"WHAT REMAINS WHEN THE NARRATOR DIES",src:"PHASE 7 · SEPARATION · COMPLETE"},
    {at:54, narr:"",src:""},
  ],
  inputs:{
    sero:{angle:Math.PI*0.5, color:[150,80,200], label:"RAPHE NUCLEI"},
    frag1:{angle:Math.PI*1.2, color:[80,80,80], label:"(FRAGMENTING)"},
    frag2:{angle:Math.PI*0.8, color:[60,60,60], label:"(DISSOLVING)"},
  }
},
8:{ // CONSCIENCE — empathy rewrite, vmPFC recalibration
  focusNode:7, // vmPFC
  title:"YOU ARE A NEURON IN THE VENTROMEDIAL PREFRONTAL CORTEX",
  sequence:[
    {at:0,  narr:"PERSPECTIVE SHIFT: MORAL PROCESSING",src:""},
    {at:3,  narr:"YOU ARE WHERE VALUES LIVE",src:"vmPFC · VENTROMEDIAL PREFRONTAL"},
    {at:8,  narr:"YOUR JOB: ASSIGN MEANING TO EXPERIENCE",src:"VALUATION · MORAL REASONING · EMPATHY"},
    {at:13, narr:"INSULA SIGNAL: SOMEONE IS SUFFERING",src:"INTEROCEPTIVE EMPATHY · SHARED PAIN",input:"pain",word:"THEY FEEL"},
    {at:18, narr:"AMYGDALA: EMOTIONAL CONTAGION",src:"AFFECTIVE EMPATHY PATHWAY",input:"affect",word:"I FEEL IT TOO"},
    {at:23, narr:"TPJ: THEIR PERSPECTIVE IS NOT YOURS",src:"COGNITIVE EMPATHY · SELF-OTHER DISTINCTION",input:"tpj_e",word:"BUT DIFFERENT"},
    {at:28, narr:"YOU RECALCULATE — WHAT MATTERS?",src:"VALUE RECOMPUTATION · SOMATIC MARKER"},
    {at:33, narr:"THE OLD VALUATION WAS BUILT ON THE OLD SELF",src:"POST-DISSOLUTION MORAL RECALIBRATION",word:"WE SHARE"},
    {at:38, narr:"CONSCIENCE IS NOT GUILT — IT IS ACCURATE MODELING OF HARM",src:"DAMASIO · SOMATIC MARKER HYPOTHESIS"},
    {at:43, narr:"YOU CANNOT UNSEE WHAT YOU NOW SEE",src:"PHASE 8 · CONSCIENCE · COMPLETE"},
    {at:49, narr:"",src:""},
  ],
  inputs:{
    pain:{angle:Math.PI*1.4, color:[200,100,100], label:"ANTERIOR INSULA"},
    affect:{angle:Math.PI*0.8, color:[220,120,80], label:"AMYGDALA"},
    tpj_e:{angle:Math.PI*1.8, color:[100,160,220], label:"TPJ"},
  }
},
9:{ // THRESHOLD — claustrum fires, total dissolution then binding
  focusNode:10, // using precuneus as proxy for claustrum
  title:"YOU ARE A NEURON IN THE CLAUSTRUM",
  sequence:[
    {at:0,  narr:"PERSPECTIVE SHIFT: THE CONDUCTOR",src:""},
    {at:3,  narr:"YOU ARE IN THE MOST CONNECTED STRUCTURE IN THE BRAIN",src:"CLAUSTRUM · CRICK'S LAST HYPOTHESIS"},
    {at:8,  narr:"YOUR JOB: BIND EVERYTHING INTO ONE EXPERIENCE",src:"CONSCIOUSNESS INTEGRATION · GLOBAL WORKSPACE"},
    {at:13, narr:"THE NETWORK IS DISSOLVED — SILENCE",src:"DMN CONNECTIVITY: 2% · NEAR-ISOELECTRIC"},
    {at:18, narr:"BUT YOU ARE STILL HERE",src:"THE CLAUSTRUM PERSISTS WHEN ALL ELSE FALLS"},
    {at:23, narr:"YOU BEGIN TO FIRE",src:"SINGLE SPIKE → BURST → CASCADE",input:"spark",word:""},
    {at:28, narr:"ONE SIGNAL — EVERYWHERE AT ONCE",src:"CLAUSTRO-CORTICAL BROADCAST",input:"broadcast",word:""},
    {at:33, narr:"EVERY REGION RECEIVES THE SAME PULSE SIMULTANEOUSLY",src:"GLOBAL SYNCHRONIZATION EVENT"},
    {at:38, narr:"THIS IS THE MOMENT BETWEEN DEATH AND RESURRECTION",src:"THE THRESHOLD · THE LIMEN"},
    {at:43, narr:"FRANCIS CRICK DIED STUDYING THIS STRUCTURE",src:"CRICK & KOCH 2005 · WHAT IS THE CLAUSTRUM"},
    {at:48, narr:"THE QUESTION WAS NEVER ANSWERED",src:"PHASE 9 · THRESHOLD · COMPLETE"},
    {at:54, narr:"",src:""},
  ],
  inputs:{
    spark:{angle:Math.PI*0.5, color:[255,255,200], label:"INTRINSIC"},
    broadcast:{angle:Math.PI*1.0, color:[255,220,100], label:"→ ALL CORTEX"},
  }
},
10:{ // RESURRECTION — novel topology, DMN reconstituted differently
  focusNode:0, // Back to mPFC — but CHANGED
  title:"YOU ARE THE SAME NEURON — BUT YOUR WIRING IS DIFFERENT",
  sequence:[
    {at:0,  narr:"RETURN TO THE mPFC",src:""},
    {at:3,  narr:"THE SAME NEURON — THE SAME POSITION",src:"mPFC · MEDIAL PREFRONTAL CORTEX"},
    {at:8,  narr:"BUT THE CONNECTIONS ARE NOT THE SAME",src:"NOVEL TOPOLOGY · NEUROPLASTIC REORGANIZATION"},
    {at:13, narr:"HIPPOCAMPUS SIGNAL — FAMILIAR BUT RECONTEXTUALIZED",src:"MEMORY RECONSOLIDATION",input:"hippo2",word:"I REMEMBER"},
    {at:18, narr:"AMYGDALA — PRESENT BUT INTEGRATED",src:"REGULATED THREAT RESPONSE",input:"amyg2",word:"I ACCEPT"},
    {at:23, narr:"INSULA — CLEARER THAN BEFORE",src:"ENHANCED INTEROCEPTION",input:"insula2",word:"I FEEL"},
    {at:28, narr:"TPJ — EXPANDED: NOT JUST THEM BUT US",src:"BROADENED SOCIAL COGNITION",input:"tpj2",word:"WE ARE"},
    {at:33, narr:"PCC — CONTINUITY RESTORED WITH NEW DATA",src:"UPDATED AUTOBIOGRAPHY",input:"pcc2",word:"I BUILD"},
    {at:38, narr:"INTEGRATION THRESHOLD",src:"NOVEL SELF-MODEL COMPILED",word:"SOURCE"},
    {at:43, narr:"YOU ARE NOT WHO YOU WERE AT PHASE 0",src:"THE NARRATIVE IS DIFFERENT BECAUSE YOU ARE"},
    {at:48, narr:"THE HELIX DOES NOT RETURN YOU TO THE BEGINNING",src:"IT RETURNS YOU TO THE BEGINNING — CHANGED"},
    {at:53, narr:"",src:"PHASE 10 · RESURRECTION · COMPLETE"},
    {at:59, narr:"",src:""},
  ],
  inputs:{
    hippo2:{angle:Math.PI*0.8, color:[140,200,160], label:"HIPPOCAMPUS"},
    amyg2:{angle:Math.PI*1.3, color:[200,140,120], label:"AMYGDALA"},
    insula2:{angle:Math.PI*0.3, color:[180,140,220], label:"INSULA"},
    tpj2:{angle:Math.PI*1.7, color:[120,180,240], label:"TPJ"},
    pcc2:{angle:Math.PI*0.0, color:[200,180,120], label:"PCC"},
  }
}
};

var immActiveInputs=[];// signals currently arriving
var immAssembledWords=[];// narrative fragments that have been bound
var immLastSeqIdx=-1;

function enterPhaseExperience(){
  if(immersiveMode)return;
  if(!PHASE_EXP[phase])return;// no experience built for this phase yet
  
  immersiveMode=true;
  immersiveT=0;
  immersiveFocusNode=PHASE_EXP[phase].focusNode;
  immersiveZoom=0;
  immActiveInputs=[];
  immAssembledWords=[];
  immLastSeqIdx=-1;
  
  // Hide HUD
  hideEnterBtn();
  document.getElementById('plabel').style.opacity='0';
  document.getElementById('nav').style.opacity='0';
  document.getElementById('htl').style.opacity='0';
  document.getElementById('htr').style.opacity='0';
  document.getElementById('hbl').style.opacity='0';
  document.getElementById('hbr').style.opacity='0';
  
  // Show exit button after 5s
  setTimeout(function(){document.getElementById('immersive-exit').classList.add('vis')},5000);
}

function exitPhaseExperience(){
  immersiveMode=false;
  immersiveZoom=0;
  
  // Restore HUD
  document.getElementById('plabel').style.opacity='1';
  document.getElementById('nav').style.opacity='1';
  document.getElementById('htl').style.opacity='1';
  document.getElementById('htr').style.opacity='1';
  document.getElementById('hbl').style.opacity='1';
  document.getElementById('hbr').style.opacity='1';
  document.getElementById('immersive-exit').classList.remove('vis');
  document.getElementById('immersive-narration').style.color='rgba(201,169,78,0)';
  document.getElementById('immersive-source').style.color='rgba(201,169,78,0)';
  
  enterTimer=setTimeout(showEnterBtn,2000);
}

// Draw immersive experience — called from main draw loop
function drawImmersive(ctx,p,W,H,t){
  var exp=PHASE_EXP[phase];
  if(!exp)return;
  
  var cx=W/2,cy=H/2;
  var aRGB=p.aR+','+p.aG+','+p.aB;
  var elapsed=immersiveT/60;// seconds (approx at 60fps)
  
  // ── ZOOM TRANSITION (first 3 seconds) ──
  if(immersiveZoom<1)immersiveZoom=Math.min(1,immersiveZoom+0.008);
  var zoom=immersiveZoom;
  var easeZoom=zoom*zoom*(3-2*zoom);// smoothstep
  
  // Focus node position
  var fn=DMN_NODES[exp.focusNode];
  var fnx=fn.x*W,fny=fn.y*H;
  
  // ── BACKGROUND: deep space, darker as we go in ──
  var bg=ctx.createRadialGradient(cx,cy,0,cx,cy,Math.max(W,H)*0.7);
  bg.addColorStop(0,'rgba('+Math.floor(p.aR*0.04)+','+Math.floor(p.aG*0.04)+','+Math.floor(p.aB*0.04)+',1)');
  bg.addColorStop(1,'rgba(0,0,0,1)');
  ctx.fillStyle=bg;ctx.fillRect(0,0,W,H);
  
  // ── During zoom: DMN nodes shrink away except focus ──
  if(easeZoom<1){
    for(var ni=0;ni<DMN_NODES.length;ni++){
      if(ni===exp.focusNode)continue;
      var nd=DMN_NODES[ni];
      var nx=nd.x*W,ny=nd.y*H;
      // Nodes drift outward and fade
      var dx=nx-fnx,dy=ny-fny;
      var pushOut=easeZoom*3;
      nx+=dx*pushOut;ny+=dy*pushOut;
      var fadeAlpha=(1-easeZoom)*0.3;
      if(fadeAlpha>0.01){
        ctx.beginPath();ctx.arc(nx,ny,6*(1-easeZoom),0,Math.PI*2);
        ctx.fillStyle='rgba('+aRGB+','+fadeAlpha+')';ctx.fill();
      }
    }
  }
  
  // ── THE SOMA — you are inside it ──
  // Membrane boundary — pulsing circle
  var somaR=Math.min(W,H)*0.3*(0.5+easeZoom*0.5);
  var breathe=Math.sin(immersiveT*0.02)*0.03+1;
  somaR*=breathe;
  
  // Membrane — lipid bilayer ring
  var memAlpha=0.08+easeZoom*0.12;
  // Phase 7: membrane dissolves
  if(phase===7&&elapsed>13)memAlpha*=Math.max(0.05,1-(elapsed-13)/40);
  ctx.beginPath();ctx.arc(cx,cy,somaR,0,Math.PI*2);
  ctx.strokeStyle='rgba('+aRGB+','+memAlpha+')';
  ctx.lineWidth=2+easeZoom*3;
  if(phase===7&&elapsed>25)ctx.setLineDash([8,8+Math.min(20,(elapsed-25)*2)]);
  ctx.stroke();ctx.setLineDash([]);
  // Double membrane
  ctx.beginPath();ctx.arc(cx,cy,somaR+4,0,Math.PI*2);
  ctx.strokeStyle='rgba('+aRGB+','+(memAlpha*0.4)+')';
  ctx.lineWidth=1;ctx.stroke();
  
  // Ion channel pores around membrane
  var poreCount=24;
  for(var pi=0;pi<poreCount;pi++){
    var pa=(pi/poreCount)*Math.PI*2+immersiveT*0.003;
    var px=cx+Math.cos(pa)*somaR;
    var py=cy+Math.sin(pa)*somaR;
    var poreOpen=Math.sin(immersiveT*0.05+pi*2.3)>0.3;
    ctx.beginPath();ctx.arc(px,py,poreOpen?3.5:2,0,Math.PI*2);
    ctx.fillStyle=poreOpen?'rgba('+aRGB+','+(memAlpha*1.5)+')':'rgba(40,40,50,'+(memAlpha)+')';
    ctx.fill();
  }
  
  // ── NUCLEUS at center ──
  var nucR=somaR*0.15;
  var nucGrad=ctx.createRadialGradient(cx,cy,0,cx,cy,nucR);
  nucGrad.addColorStop(0,'rgba(255,255,255,0.12)');
  nucGrad.addColorStop(0.5,'rgba('+aRGB+',0.08)');
  nucGrad.addColorStop(1,'rgba('+aRGB+',0.02)');
  ctx.fillStyle=nucGrad;ctx.beginPath();ctx.arc(cx,cy,nucR,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(cx,cy,nucR,0,Math.PI*2);
  ctx.strokeStyle='rgba('+aRGB+',0.1)';ctx.lineWidth=1;ctx.stroke();
  
  // ── DENDRITES extending outward — your input receivers ──
  if(easeZoom>0.5){
    var dendAlpha=(easeZoom-0.5)*2*0.15;
    var numDendrites=6;
    for(var di=0;di<numDendrites;di++){
      var da=(di/numDendrites)*Math.PI*2+0.3;
      var dLen=somaR*0.8;
      // Main dendrite shaft
      ctx.beginPath();
      ctx.moveTo(cx+Math.cos(da)*somaR*0.1,cy+Math.sin(da)*somaR*0.1);
      var dendEndX=cx+Math.cos(da)*dLen;
      var dendEndY=cy+Math.sin(da)*dLen;
      // Slight curve
      var ctrlX=cx+Math.cos(da+0.2)*dLen*0.6;
      var ctrlY=cy+Math.sin(da+0.2)*dLen*0.6;
      ctx.quadraticCurveTo(ctrlX,ctrlY,dendEndX,dendEndY);
      ctx.strokeStyle='rgba('+aRGB+','+dendAlpha+')';
      ctx.lineWidth=2;ctx.stroke();
      
      // Dendritic spines — tiny protrusions (synaptic receivers)
      var spineCount=8;
      for(var si=0;si<spineCount;si++){
        var st=(si+1)/(spineCount+1);
        var sx=cx+Math.cos(da)*dLen*st+Math.cos(da+0.2)*dLen*st*0.2*(1-st);
        var sy=cy+Math.sin(da)*dLen*st+Math.sin(da+0.2)*dLen*st*0.2*(1-st);
        var spineAngle=da+Math.PI/2*(si%2===0?1:-1)+Math.sin(immersiveT*0.03+si)*0.3;
        var spineLen=4+Math.sin(immersiveT*0.05+si*1.7)*2;
        ctx.beginPath();
        ctx.moveTo(sx,sy);
        ctx.lineTo(sx+Math.cos(spineAngle)*spineLen,sy+Math.sin(spineAngle)*spineLen);
        ctx.strokeStyle='rgba('+aRGB+','+(dendAlpha*0.6)+')';
        ctx.lineWidth=0.8;ctx.stroke();
        // Spine head (bouton)
        ctx.beginPath();
        ctx.arc(sx+Math.cos(spineAngle)*spineLen,sy+Math.sin(spineAngle)*spineLen,1.5,0,Math.PI*2);
        ctx.fillStyle='rgba('+aRGB+','+(dendAlpha*0.5)+')';ctx.fill();
      }
    }
  }
  
  // ── RESTING POTENTIAL — subtle oscillation ──
  // Faint concentric rings pulsing outward from nucleus — membrane potential
  // Phase 7: rings get erratic and fade. Phase 9: rings are absent then BURST
  var rpAlpha=easeZoom*0.04;
  if(phase===7)rpAlpha*=Math.max(0,1-elapsed/45);// dissolving
  if(phase===9&&elapsed<23)rpAlpha=0;// silent until claustrum fires
  if(phase===9&&elapsed>=23)rpAlpha=easeZoom*0.08;// then bright
  for(var rpi=0;rpi<3;rpi++){
    var rpR=(nucR+immersiveT*0.5+rpi*30)%(somaR*0.9);
    var rpFade=1-rpR/(somaR*0.9);
    ctx.beginPath();ctx.arc(cx,cy,rpR,0,Math.PI*2);
    ctx.strokeStyle='rgba('+aRGB+','+(rpAlpha*rpFade)+')';
    ctx.lineWidth=0.5;ctx.stroke();
  }
  
  // ── PHASE 7 SPECIAL: Soma membrane dissolving ──
  if(phase===7&&elapsed>13){
    var dissP=Math.min(1,(elapsed-13)/35);
    // Membrane fragments drifting outward
    for(var di=0;di<Math.floor(dissP*30);di++){
      var dAngle=di*0.618*Math.PI*2+immersiveT*0.002;
      var dDist=somaR*(1+dissP*0.5)+di*3;
      var dx2=cx+Math.cos(dAngle)*dDist;
      var dy2=cy+Math.sin(dAngle)*dDist;
      var dAlpha=(1-dissP)*0.1;
      ctx.beginPath();ctx.arc(dx2,dy2,1.5,0,Math.PI*2);
      ctx.fillStyle='rgba('+aRGB+','+dAlpha+')';ctx.fill();
    }
  }
  
  // ── PHASE 9 SPECIAL: Claustrum broadcast flash ──
  if(phase===9&&elapsed>=28&&elapsed<32){
    var broadP=(elapsed-28)/4;
    var flashR=broadP*Math.max(W,H);
    var flashAlpha=(1-broadP)*0.15;
    ctx.beginPath();ctx.arc(cx,cy,flashR,0,Math.PI*2);
    ctx.strokeStyle='rgba(255,255,200,'+flashAlpha+')';
    ctx.lineWidth=3;ctx.stroke();
    // Inner glow
    var bGrad=ctx.createRadialGradient(cx,cy,0,cx,cy,flashR*0.5);
    bGrad.addColorStop(0,'rgba(255,255,200,'+(flashAlpha*0.3)+')');
    bGrad.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=bGrad;ctx.beginPath();ctx.arc(cx,cy,flashR*0.5,0,Math.PI*2);ctx.fill();
  }
  
  // ── SEQUENCE EVENTS — narration + input signals ──
  var seq=exp.sequence;
  for(var si=0;si<seq.length;si++){
    if(elapsed>=seq[si].at&&si>immLastSeqIdx){
      immLastSeqIdx=si;
      var narrEl=document.getElementById('immersive-narration');
      var srcEl=document.getElementById('immersive-source');
      
      // Fade out then in
      narrEl.style.color='rgba(201,169,78,0)';
      srcEl.style.color='rgba(201,169,78,0)';
      (function(s){setTimeout(function(){
        narrEl.textContent=s.narr;
        srcEl.textContent=s.src;
        if(s.narr)narrEl.style.color='rgba(201,169,78,0.9)';
        if(s.src)srcEl.style.color='rgba(201,169,78,0.5)';
      },400)})(seq[si]);
      
      // Trigger input signal
      if(seq[si].input&&exp.inputs[seq[si].input]){
        var inp=exp.inputs[seq[si].input];
        immActiveInputs.push({
          angle:inp.angle,
          color:inp.color,
          label:inp.label,
          word:seq[si].word,
          startT:immersiveT,
          duration:300,// frames
          arrived:false
        });
      }
      // Word assembly (no input signal, just convergence)
      if(seq[si].word&&!seq[si].input){
        immAssembledWords.push(seq[si].word);
      }
      
      // Auto-exit at end
      if(si===seq.length-1){
        setTimeout(exitPhaseExperience,4000);
      }
    }
  }
  
  // ── DRAW ACTIVE INPUT SIGNALS ──
  for(var ii=immActiveInputs.length-1;ii>=0;ii--){
    var inp=immActiveInputs[ii];
    var inpProgress=(immersiveT-inp.startT)/inp.duration;
    if(inpProgress>1.5){immActiveInputs.splice(ii,1);continue;}
    
    var iR=inp.color[0],iG=inp.color[1],iB=inp.color[2];
    var iRGB=iR+','+iG+','+iB;
    
    if(inpProgress<=1){
      // Signal traveling inward — from edge of screen toward soma
      var startDist=Math.max(W,H)*0.7;
      var endDist=somaR*0.3;
      var currentDist=startDist+(endDist-startDist)*inpProgress*inpProgress;
      var sx=cx+Math.cos(inp.angle)*currentDist;
      var sy=cy+Math.sin(inp.angle)*currentDist;
      
      // Signal packet — bright leading point with trail
      var sigAlpha=Math.sin(inpProgress*Math.PI)*0.9;
      var sigGrad=ctx.createRadialGradient(sx,sy,0,sx,sy,15);
      sigGrad.addColorStop(0,'rgba(255,255,255,'+sigAlpha+')');
      sigGrad.addColorStop(0.3,'rgba('+iRGB+','+(sigAlpha*0.8)+')');
      sigGrad.addColorStop(1,'rgba(0,0,0,0)');
      ctx.fillStyle=sigGrad;ctx.beginPath();ctx.arc(sx,sy,15,0,Math.PI*2);ctx.fill();
      
      // Core
      ctx.beginPath();ctx.arc(sx,sy,3,0,Math.PI*2);
      ctx.fillStyle='rgba(255,255,255,'+(sigAlpha*0.9)+')';ctx.fill();
      
      // Trail
      for(var tr=1;tr<=10;tr++){
        var tp=Math.max(0,inpProgress-tr*0.02);
        var td=startDist+(endDist-startDist)*tp*tp;
        var tx=cx+Math.cos(inp.angle)*td;
        var ty=cy+Math.sin(inp.angle)*td;
        ctx.beginPath();ctx.arc(tx,ty,2.5-tr*0.2,0,Math.PI*2);
        ctx.fillStyle='rgba('+iRGB+','+(sigAlpha*(1-tr/11)*0.4)+')';ctx.fill();
      }
      
      // Source label — where it's coming from
      if(inpProgress<0.4){
        var labelDist=startDist-40;
        var lx=cx+Math.cos(inp.angle)*labelDist;
        var ly=cy+Math.sin(inp.angle)*labelDist;
        ctx.font='10px monospace';ctx.textAlign='center';
        ctx.fillStyle='rgba('+iRGB+','+(0.4*(1-inpProgress/0.4))+')';
        ctx.fillText(inp.label,lx,ly);
      }
      
      // Arrival flash
      if(inpProgress>0.95&&!inp.arrived){
        inp.arrived=true;
        if(inp.word)immAssembledWords.push(inp.word);
      }
    }
    
    // Post-arrival — soma brightens with that signal's color
    if(inp.arrived){
      var postP=Math.min(1,(inpProgress-1)*2);
      var flashAlpha=(1-postP)*0.15;
      var flashGrad=ctx.createRadialGradient(cx,cy,0,cx,cy,somaR*0.6);
      flashGrad.addColorStop(0,'rgba('+iRGB+','+flashAlpha+')');
      flashGrad.addColorStop(1,'rgba(0,0,0,0)');
      ctx.fillStyle=flashGrad;ctx.beginPath();ctx.arc(cx,cy,somaR*0.6,0,Math.PI*2);ctx.fill();
    }
  }
  
  // ── ASSEMBLED NARRATIVE — the words you've bound ──
  if(immAssembledWords.length>0){
    var isMob=W<600;
    var wordSize=isMob?Math.round(W*0.038):Math.round(Math.min(20,W*0.025));
    ctx.font='bold '+wordSize+'px monospace';
    ctx.textAlign='center';
    
    if(isMob&&immAssembledWords.length>3){
      // Stack vertically on mobile when many words
      var lineH=wordSize+8;
      var startY=cy+somaR*0.35;
      // Background
      var maxTw=0;
      for(var wi=0;wi<immAssembledWords.length;wi++){
        var tw2=ctx.measureText(immAssembledWords[wi]).width;
        if(tw2>maxTw)maxTw=tw2;
      }
      ctx.fillStyle='rgba(0,0,0,0.5)';
      ctx.fillRect(cx-maxTw/2-16,startY-wordSize-4,maxTw+32,immAssembledWords.length*lineH+12);
      
      for(var wi=0;wi<immAssembledWords.length;wi++){
        var wordAlpha=0.7+Math.sin(immersiveT*0.03+wi)*0.15;
        ctx.fillStyle='rgba('+aRGB+','+wordAlpha+')';
        ctx.fillText(immAssembledWords[wi],cx,startY+wi*lineH);
      }
    }else{
      // Horizontal for few words or desktop
      var wordStr=immAssembledWords.join('  ·  ');
      var tw=ctx.measureText(wordStr).width;
      ctx.fillStyle='rgba(0,0,0,0.5)';
      ctx.fillRect(cx-tw/2-20,cy+somaR*0.4-wordSize-4,tw+40,wordSize+18);
      ctx.fillStyle='rgba('+aRGB+',0.75)';
      ctx.fillText(wordStr,cx,cy+somaR*0.4+5);
    }
  }
  
  // ── SPONTANEOUS FIRING — you fire occasionally ──
  var fireRate=0.5+immAssembledWords.length*0.1;
  var fireCycle=Math.sin(immersiveT*0.01*fireRate);
  if(fireCycle>0.95){
    // Action potential — bright flash from nucleus outward
    var apExpand=(fireCycle-0.95)/0.05;
    var apR=nucR+apExpand*somaR*0.8;
    ctx.beginPath();ctx.arc(cx,cy,apR,0,Math.PI*2);
    ctx.strokeStyle='rgba(255,255,255,'+(0.3*(1-apExpand))+')';
    ctx.lineWidth=2;ctx.stroke();
  }
  
  // ── CYTOPLASM texture ──
  // Faint organic noise inside the soma
  var cytoAlpha=easeZoom*0.015;
  for(var ci=0;ci<40;ci++){
    var cAngle=ci*0.618*Math.PI*2+immersiveT*0.001;
    var cDist=(ci*7.3+immersiveT*0.1)%(somaR*0.85);
    var cx2=cx+Math.cos(cAngle)*cDist;
    var cy2=cy+Math.sin(cAngle)*cDist;
    ctx.beginPath();ctx.arc(cx2,cy2,0.8+Math.sin(ci*3.1)*0.5,0,Math.PI*2);
    ctx.fillStyle='rgba('+aRGB+','+cytoAlpha+')';ctx.fill();
  }
  
  immersiveT++;
}

buildNav();updateHUD();checkLock();draw();
</script>
</body>
</html>
